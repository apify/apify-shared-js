# @apify/json_schemas

JSON schemas for the Apify platform — used for server-side validation, IDE autocompletion, and developer documentation.

## Schema versions

Each schema exists in three forms, each serving a different purpose:

| Version | Location | Purpose | Consumed by |
|---|---|---|---|
| **Raw** | `schemas/*.json` | Minimal, machine-oriented. Used for runtime validation. | `@apify/input_schema`, Apify platform internals |
| **Described** | `output/*.json` | Raw + human-readable descriptions in three formats (plain text, Markdown, HTML). | Available for tooling that needs rich descriptions |
| **IDE** | `output/*.ide.json` | Described + structural tweaks for autocompletion: `$id` removed, `$ref` bundled inline, `additionalProperties: false`, enum dropdowns for memory fields. | VS Code, JetBrains IDEs (via `$schema` in `actor.json`, `.actor/INPUT_SCHEMA.json`, etc.) |

The raw schemas are published to npm as part of this package and served at `https://apify.com/schemas/v1/*.json`. The IDE schemas are served at `https://apify-projects.github.io/actor-json-schemas/` and are what developers actually interact with in their editors.

## Descriptions and rules

Descriptions are verbose — multi-line Markdown with code examples, links, and formatting. Inlining them into the JSON schema source files would make those files hard to read and maintain. Instead, descriptions live in declarative XML rule files (`rules/add-description/*.xml`) that map JSON pointers to Markdown content. A build step merges them into the schemas automatically.

This separation means schema structure and documentation can be reviewed and updated independently.

## Directory overview

```
packages/json_schemas/
├── src/                    # Published library source (npm package)
├── schemas/                # Raw JSON schemas (source of truth)
├── rules/                  # Description & modification rules (XML)
│   ├── add-description/    # Markdown descriptions for schema properties
│   └── modifications/      # IDE-specific structural changes
├── scripts/                # Build & processing scripts
├── tools/                  # Build-time processing engine (not published)
│   ├── modificator/        # Applies XML rules to schemas
│   └── bundler/            # Inlines $ref references
├── output/                 # Generated described & IDE schemas (committed)
└── dist/                   # Compiled npm package (gitignored)
```

## Source files you should edit

### Schema definitions

- **`src/actor.schema.ts`** — The actor schema, defined as a TypeScript object. This is the source of truth for `schemas/actor.schema.json` (which is generated from it — don't edit the JSON directly).
- **`schemas/dataset.schema.json`**, **`input.schema.json`**, **`key_value_store.schema.json`**, **`output.schema.json`** — Static JSON files. Edit these directly when changing schema structure.
- **`schemas/json-schema-draft-07.json`** — Standard JSON Schema Draft-07 meta-schema, used as a `$ref` target by other schemas.

### Description rules (`rules/add-description/`)

One XML file per schema (e.g., `actor.description-rules.xml`). Each file contains `<AddDescription>` elements that map a JSON pointer to Markdown content:

```xml
<AddDescription json-path="/properties/minMemoryMbytes" format="markdown">
    An integer between `128` and `32768` specifying the minimum memory in megabytes required.
</AddDescription>
```

This produces three fields on the target property: `description` (plain text), `markdownDescription` (for VS Code), and `x-intellij-html-description` (for JetBrains).

### Modification rules (`rules/modifications/`)

One XML file per schema. These define structural changes applied when producing IDE schemas. Three rule types are available:

- **`RemoveValue`** — Delete a property (e.g., remove `$id` from all schemas)
- **`ReplaceValue`** — Replace a value with a JSON literal or a JS expression that can reference the current `value`
- **`AddDescription`** — Same as in description rules (can also be used here for IDE-only descriptions)

Example — rewrite `$ref` URLs to relative paths:
```xml
<ReplaceValue json-path="**/$ref" type="js">
    value.replace(/^https:\/\/apify\.com\/schemas\/v1\/(.+)\.json/, '$1.ide.json')
</ReplaceValue>
```

### Library source (`src/`)

| File | Purpose |
|---|---|
| `index.ts` | Package entry point |
| `schemas.ts` | Re-exports raw JSON schemas for programmatic use |
| `validations.ts` | AJV-based validation functions |
| `actor.schema.ts` | Code-first actor schema definition |

## Generated files (don't edit)

- **`schemas/actor.schema.json`** — Generated from `src/actor.schema.ts`. Edit the TypeScript source instead.
- **`output/*.json`** and **`output/*.ide.json`** — Generated by `npm run process-schemas`. Re-run the pipeline instead of editing by hand.

## Build-time tools (`tools/`)

Ported from the [actor-json-schemas](https://github.com/apify-projects/actor-json-schemas) repository. These implement the schema processing engine and are only used at build time (not included in the npm package). You shouldn't need to modify these unless the processing logic itself needs changing.

- **`tools/modificator/`** — Parses XML rule files (via cheerio) and applies transformations to JSON schemas. Core function: `enchantJsonSchema(schema, rules)`.
- **`tools/bundler/`** — Resolves external `$ref` references (local files and URLs) and inlines them into a `definitions` block. Core function: `bundleJsonSchema(filePath)`.

## Processing pipeline

```
src/actor.schema.ts ──> schemas/actor.schema.json ─┐
                                                    │
schemas/*.json  (raw source schemas) ───────────────┤
                                                    v
                               ┌─── describe-schemas.ts ───┐
                               │  + rules/add-description/ │
                               └────────────┬──────────────┘
                                            v
                                     output/*.json  (described)
                                            │
                               ┌── build-ide-schemas.ts ───┐
                               │  + rules/modifications/   │
                               │  + bundler (inline $ref)  │
                               └────────────┬──────────────┘
                                            v
                                   output/*.ide.json  (IDE-ready)
```

## npm scripts

| Script | What it does |
|---|---|
| `npm run build` | Full npm package build (clean, process-schemas, compile, copy) |
| `npm run build-schemas` | Generate `schemas/actor.schema.json` from TypeScript source |
| `npm run describe-schemas` | Apply description rules to raw schemas, write `output/*.json` |
| `npm run build-ide-schemas` | Apply modification rules + bundle `$ref`, write `output/*.ide.json` |
| `npm run process-schemas` | Run all three steps above in sequence |

## Typical workflow

After changing a schema, description rule, or modification rule:

```bash
npm run process-schemas
```

This regenerates all files in `output/`. Commit the updated output alongside your source changes.
