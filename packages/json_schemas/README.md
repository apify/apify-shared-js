# @apify/json_schemas

Publicly available JSON schemas for the Apify platform. This package provides raw schemas, validation utilities, and a processing pipeline that produces enriched schemas for IDE autocompletion.

## Directory structure

```
packages/json_schemas/
├── src/                    # Published library source (npm package)
├── schemas/                # Raw JSON schema files (source of truth)
├── scripts/                # Build & processing scripts
├── tools/                  # Build-time utilities (not published)
│   ├── modificator/        # Schema enchantment engine
│   └── bundler/            # $ref bundling engine
├── rules/                  # XML rule definitions for schema processing
│   ├── add-description/    # Description enrichment rules
│   └── modifications/      # IDE modification rules
├── output/                 # Generated schemas (committed)
└── dist/                   # Compiled npm package (gitignored)
```

## What each directory does

### `src/` — Published library code

The TypeScript source that gets compiled and published to npm. Exports the raw schemas and AJV-based validation functions.

| File | Purpose |
|---|---|
| `index.ts` | Package entry point, re-exports schemas and validations |
| `schemas.ts` | Imports and re-exports raw JSON schemas from `schemas/` |
| `validations.ts` | AJV-based validator functions for each schema type |
| `actor.schema.ts` | Code-first actor schema definition (TypeScript object) |

### `schemas/` — Raw JSON schema files

The source-of-truth schema files. Five schemas correspond to Apify platform resources, plus a copy of JSON Schema Draft-07 used as a `$ref` target.

| File | Notes |
|---|---|
| `actor.schema.json` | **Generated** from `src/actor.schema.ts` by `build-schemas` script. Do not edit directly. |
| `dataset.schema.json` | Static file. Edit directly. |
| `input.schema.json` | Static file. Edit directly. |
| `key_value_store.schema.json` | Static file. Edit directly. |
| `output.schema.json` | Static file. Edit directly. |
| `json-schema-draft-07.json` | Static file. Standard JSON Schema Draft-07 meta-schema. |

### `scripts/` — Build and processing scripts

| File | Runner | Purpose |
|---|---|---|
| `build-schemas.ts` | `ts-node` | Generates `schemas/actor.schema.json` from `src/actor.schema.ts` |
| `describe-schemas.ts` | `tsx` | Applies description rules to raw schemas, writes `output/*.json` |
| `build-ide-schemas.ts` | `tsx` | Applies modification rules and bundles `$ref`, writes `output/*.ide.json` |

### `tools/` — Build-time utilities (not published)

Ported from the [actor-json-schemas](https://github.com/apify-projects/actor-json-schemas) repository. These are used only by the processing scripts and are excluded from the npm package.

#### `tools/modificator/`

The schema enchantment engine. Parses XML rule files and applies transformations (add descriptions, replace values, remove values) to JSON schemas.

| File | Purpose |
|---|---|
| `types.ts` | Core type definitions (`JsonObject`, `Rule`, `ObjectPropertyInfo`, etc.) |
| `utils.ts` | `enchantJsonSchema()` — applies rules to a schema; `getJsonValue()`, `parseJsonContent()` |
| `description-file-utils.ts` | `parseRuleFile()` — parses XML into rule objects using cheerio |
| `rules/add-description-rule.ts` | `AddDescription` rule — adds `description`, `markdownDescription`, `x-intellij-html-description` |
| `rules/replace-value-rule.ts` | `ReplaceValue` rule — replaces values via JSON literal or JS expression (`vm`) |
| `rules/remove-value-rule.ts` | `RemoveValue` rule — removes a value at a JSON pointer |

#### `tools/bundler/`

The `$ref` bundling engine. Resolves external `$ref` references (file paths and URLs) and inlines them into a `definitions` block.

| File | Purpose |
|---|---|
| `types.ts` | Type definitions (`JsonSchemaObject`, `JsonSchemaValue`) |
| `utils.ts` | `bundleJsonSchema()` — loads a schema and inlines all `$ref`; `scopeJsonSchema()` — recursive resolver |

### `rules/` — XML rule definitions

XML files that declaratively define how schemas should be transformed. Each schema has two rule files: one for descriptions, one for IDE modifications.

#### `rules/add-description/`

Define `AddDescription` rules that enrich schema properties with human-readable descriptions in three formats: plain text (`description`), Markdown (`markdownDescription`), and HTML (`x-intellij-html-description`).

#### `rules/modifications/`

Define structural modifications for IDE schemas: removing `$id`, rewriting `$ref` to relative `.ide.json` paths, setting `additionalProperties: false`, replacing values for better DX (e.g., memory enums).

### `output/` — Generated and committed schemas

Generated by `npm run process-schemas`. These files are committed to the repository and are intended to replace the output previously hosted via the [actor-json-schemas](https://github.com/apify-projects/actor-json-schemas) GitHub Pages.

| Pattern | Description |
|---|---|
| `*.json` | **Described schemas** — raw schemas enriched with description fields |
| `*.ide.json` | **IDE schemas** — described schemas with IDE modifications applied and all `$ref` bundled inline |

## What to edit vs. what not to edit

### Safe to edit

| What | When |
|---|---|
| `src/actor.schema.ts` | Changing the actor schema structure |
| `schemas/dataset.schema.json` | Changing the dataset schema |
| `schemas/input.schema.json` | Changing the input schema |
| `schemas/key_value_store.schema.json` | Changing the key-value store schema |
| `schemas/output.schema.json` | Changing the output schema |
| `rules/add-description/*.xml` | Adding/changing property descriptions |
| `rules/modifications/*.xml` | Changing IDE-specific transformations |
| `src/validations.ts` | Changing validation logic |

### Do not edit manually

| What | Why |
|---|---|
| `schemas/actor.schema.json` | Generated from `src/actor.schema.ts`. Edit the `.ts` file instead. |
| `output/*.json`, `output/*.ide.json` | Generated by `process-schemas`. Re-run the script instead. |
| `tools/**` | Ported from actor-json-schemas. Only change if the processing logic itself needs fixing. |

## npm scripts

| Script | Description |
|---|---|
| `npm run build` | Full npm package build: clean, build-schemas, compile (tsup), copy |
| `npm run build-schemas` | Generate `schemas/actor.schema.json` from TypeScript source |
| `npm run describe-schemas` | Apply description rules: `schemas/*` &rarr; `output/*.json` |
| `npm run build-ide-schemas` | Apply modification rules + bundle `$ref`: `output/*.json` &rarr; `output/*.ide.json` |
| `npm run process-schemas` | Full pipeline: `build-schemas` &rarr; `describe-schemas` &rarr; `build-ide-schemas` |

## Schema processing pipeline

```
src/actor.schema.ts ──► schemas/actor.schema.json ─┐
                                                    │
schemas/*.json  (raw source schemas) ───────────────┤
                                                    ▼
                               ┌─── describe-schemas.ts ───┐
                               │  + rules/add-description/ │
                               └────────────┬──────────────┘
                                            ▼
                                     output/*.json  (described)
                                            │
                               ┌── build-ide-schemas.ts ───┐
                               │  + rules/modifications/   │
                               │  + bundler (inline $ref)  │
                               └────────────┬──────────────┘
                                            ▼
                                   output/*.ide.json  (IDE-ready)
```

## Workflow

After changing any schema or rule file:

```bash
npm run process-schemas
```

This regenerates all `output/` files. Commit the updated output alongside your source changes.
